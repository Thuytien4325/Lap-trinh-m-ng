<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f4f4f4;
      }
      .chat-container {
        width: 400px;
        height: 500px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        display: flex;
        flex-direction: column-reverse;
        overflow-y: auto;
        padding: 10px;
      }
      .message {
        padding: 8px 12px;
        margin: 5px;
        border-radius: 12px;
        max-width: 70%;
        word-wrap: break-word;
      }
      .sent {
        align-self: flex-end;
        background: #4caf50;
        color: white;
      }
      .received {
        align-self: flex-start;
        background: #ddd;
      }
      .attachments {
        margin-top: 5px;
      }
      .attachment {
        margin-right: 10px;
        max-width: 100px;
        max-height: 100px;
      }
      .input-container {
        display: flex;
        margin-top: 10px;
      }
      input,
      button {
        padding: 10px;
        font-size: 16px;
      }
      input {
        flex: 1;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        margin-left: 5px;
        background: #28a745;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div>
      <div class="chat-container" id="chat-box"></div>
      <div class="input-container">
        <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
        <button onclick="sendMessage()">G·ª≠i</button>
      </div>
    </div>

    <script>
      const conversationId = 1; // Thay b·∫±ng ID th·∫≠t
      const chatBox = document.getElementById('chat-box');
      const accessToken =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0IiwidXNlcl9pZCI6MiwiZXhwIjoxNzQzNzAxMzU1fQ.tO_yUBpWl5s8dImJZ2nZJ20gDndtQKOEgsMEQfX8V34'; // üî• Token l·∫•y sau khi ƒëƒÉng nh·∫≠p
      let username = ''; // Bi·∫øn ƒë·ªÉ l∆∞u username

      // üü¢ L·∫•y username t·ª´ API /users/
      async function fetchUsername() {
        try {
          const response = await fetch(`http://127.0.0.1:8000/users/`, {
            method: 'GET',
            headers: {
              Authorization: `Bearer ${accessToken}`,
              'Content-Type': 'application/json',
            },
          });

          if (!response.ok) {
            throw new Error(`L·ªói: ${response.status}`);
          }

          const userData = await response.json();
          username = userData.username; // L∆∞u username l·∫•y ƒë∆∞·ª£c
          console.log('Username:', username);
          connectWebSocket(); // Sau khi c√≥ username, k·∫øt n·ªëi WebSocket
          fetchMessages(); // T·∫£i tin nh·∫Øn ngay sau khi k·∫øt n·ªëi
        } catch (error) {
          console.error('L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:', error);
        }
      }

      // üü¢ K·∫øt n·ªëi WebSocket
      let socket = null;

      function connectWebSocket() {
        const wsUrl = `ws://127.0.0.1:8000/ws/user/${username}`;
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
          console.log('WebSocket k·∫øt n·ªëi th√†nh c√¥ng!');
        };

        socket.onmessage = (event) => {
          const message = JSON.parse(event.data);
          if (message.type === 'message_deleted') {
            alert(`Tin nh·∫Øn v·ªõi ID ${message.message_id} ƒë√£ b·ªã x√≥a.`);
            // C·∫≠p nh·∫≠t l·∫°i giao di·ªán n·∫øu c·∫ßn
            fetchMessages();
          }
        };

        socket.onclose = () => {
          console.log('WebSocket b·ªã ƒë√≥ng');
        };
      }

      // üü¢ L·∫•y tin nh·∫Øn t·ª´ API
      async function fetchMessages() {
        try {
          const response = await fetch(
            `http://127.0.0.1:8000/messages/7/messages?limit=20&offset=0`,
            {
              method: 'GET',
              headers: {
                Authorization: `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
              },
            }
          );

          if (!response.ok) {
            throw new Error(`L·ªói: ${response.status}`);
          }

          const messages = await response.json();
          console.log('Messages:', messages); // In ra console ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
          renderMessages(messages); // Hi·ªÉn th·ªã tin nh·∫Øn
        } catch (error) {
          console.error('L·ªói khi t·∫£i tin nh·∫Øn:', error);
        }
      }

      // üé® Hi·ªÉn th·ªã tin nh·∫Øn l√™n giao di·ªán
      function renderMessages(messages) {
        chatBox.innerHTML = ''; // X√≥a n·ªôi dung c≈©

        // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ tin nh·∫Øn
        if (messages.messages && messages.messages.length === 0) {
          chatBox.innerHTML = '<div>Kh√¥ng c√≥ tin nh·∫Øn n√†o.</div>';
          return;
        }

        messages.messages.reverse().forEach((msg) => {
          const messageDiv = document.createElement('div');
          messageDiv.classList.add(
            'message',
            msg.sender_id === 2 ? 'sent' : 'received'
          ); // Gi·∫£ s·ª≠ ID 2 l√† ng∆∞·ªùi d√πng hi·ªán t·∫°i
          messageDiv.textContent = msg.content;

          // Hi·ªÉn th·ªã c√°c t·ªáp ƒë√≠nh k√®m (n·∫øu c√≥)
          if (msg.attachments && msg.attachments.length > 0) {
            const attachmentsDiv = document.createElement('div');
            attachmentsDiv.classList.add('attachments');

            msg.attachments.forEach((attachment) => {
              const fileElement = document.createElement('img');
              fileElement.src = attachment.file_url;
              fileElement.classList.add('attachment');
              fileElement.alt = 'File ƒë√≠nh k√®m';
              attachmentsDiv.appendChild(fileElement);
            });

            messageDiv.appendChild(attachmentsDiv);
          }

          chatBox.appendChild(messageDiv);
        });
      }

      // üöÄ G·ª≠i tin nh·∫Øn m·ªõi (G·ª≠i token qua Header)
      async function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();
        if (!content) return;

        try {
          const response = await fetch(`http://127.0.0.1:8000/messages/`, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${accessToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              conversation_id: conversationId,
              content: content,
            }),
          });

          if (response.ok) {
            messageInput.value = '';
            fetchMessages(); // C·∫≠p nh·∫≠t danh s√°ch tin nh·∫Øn
          } else {
            console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', await response.json());
          }
        } catch (error) {
          console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', error);
        }
      }

      fetchUsername(); // G·ªçi h√†m l·∫•y username khi trang t·∫£i
    </script>
  </body>
</html>
